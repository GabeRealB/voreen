FROM ubuntu:16.04

ENV TZ=Europe/Berlin

# enable source repositories
RUN sed -i '/deb-src/s/^# //' /etc/apt/sources.list
# enable backports
RUN sed -i '/backports/s/^# //' /etc/apt/sources.list && apt-get update
# prefer backports
RUN echo "Package: *\nPin: release a=xenial-backports\nPin-Priority: 600" >> /etc/apt/preferences

RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone \
    && apt-get update \
    && apt-get install --no-install-recommends -y \
            make \
            cmake \
            g++ \
            git \
            libglew-dev \
            libboost-all-dev \
            libdevil-dev \
            libgdcm2-dev \
            libtiff5-dev \
            libswscale-dev \
            libavcodec-dev \
            libavformat-dev \
            freeglut3-dev \
            libhdf5-dev \
            libhdf5-cpp-11 \
            liblz4-dev \
            qt5-default \
            libqt5svg5-dev \
            libvtkgdcm2-dev \
            opencl-headers \
            clinfo \
            ocl-icd-libopencl1 \
            ocl-icd-opencl-dev \
            libpython3-all-dev \
            xvfb \
            iputils-ping \
            curl \
            file \
            unifdef \
            valgrind \
            ca-certificates \
            ninja-build \
            python3-mako \
            python3-requests \
            clang-6.0 \
            elfutils \
            libgcrypt11-dev \
            llvm-6.0-dev \
            libc6 \
            libdrm2 \
            libexpat1 \
            libgbm1 \
            libgl1-mesa-dri \
            libglapi-mesa \
            libx11-xcb1 \
            libxcb-dri2-0 \
            libxcb-dri3-0 \
            libxcb-present0 \
            libxcb-sync1 \
            libxcb-xfixes0 \
            libxcb1 \
            libxshmfence1 \
            libfuse2 \
            libfile-copy-recursive-perl \
            zip \
            locales \
            python3-pip

# install meson from pip (at least version 0.45 is required)
RUN pip3 install --upgrade pip setuptools
RUN pip3 install meson

# install dependencies for building mesa
RUN apt-get build-dep mesa -y

    #&& git config --global user.email "dummy@example.com" \
    #&& git config --global user.name "dummy" \
    #&& git cherry-pick 829f278ad0042b0bb5026b10e7393fa3e11498b2 \
    #&& mkdir -p build \
    #&& cd build \

# Set the locale
RUN echo en_US.UTF-8 UTF-8> /etc/locale.gen && locale-gen
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en
ENV LC_ALL en_US.UTF-8

RUN mkdir -p /build/ \
    && cd /build \
    && git clone "https://gitlab.freedesktop.org/mesa/mesa.git" --depth=1\
    && mkdir -p mesa/build \
    && cd mesa/build \
    && meson -Dplatforms=surfaceless,x11 -Dgallium-drivers=swrast -Ddri-drivers=[] -Dvulkan-drivers=[] .. .\
    && echo SETUP DONE \
    && echo CONFIGURE DONE \
    && meson .. \
    && ninja install

RUN useradd -ms /bin/bash test_user
